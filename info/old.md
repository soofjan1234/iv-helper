## 1.1 穿透交互架构

我想要在外面登录上公司里的nas，我得先在公司在nas旁边开启穿透，开启穿透（**客户端请求穿透**）：

- 服务端验证管理员身份，向云端请求 `peerID`、`peerPwd`、`accessID` 和 `accessVerify`
    - peerID和peerPwd用于服务端开启穿透
    - accessID用于客户端向云端获取穿透信息
    - accessVerify用于客户端与服务端握手连接

然后服务端会展示AccessID给用户，并且（**服务端开启穿透）**

- 服务端根据 `peer` 账号密码向穿透端开启穿透，配置隧道参数并启动隧道。

现在用户拥有了AccessID，点击远程登录，此时（**客户端获取信息**）（**客户端开启穿透**）

- 客户端通过向云端请求得到 `peerID`、`accessVerify`
- 客户端根据 `peer` 账号向穿透端开启穿透

最后（**握手连接）**

- 客户端与服务端进行握手连接，校验 `accessVerify`

## 2.1 代码

### 2.1.1. lincaccessbackend

主要负责实现远程访问和隧道连接功能

1. 核心功能
远程访问：通过 P2P 隧道技术实现设备的远程访问，允许用户从外部网络访问本地设备。
隧道管理：负责隧道的创建、连接、断开等操作，确保数据传输的安全性和稳定性。
网络状态监控：监听设备的网络状态变化，自动调整隧道连接策略。
后台服务：通过 HostService 实现后台运行，确保隧道连接的持续性和可靠性。
2. 主要类与文件
HostService.kt：后台服务类，负责隧道连接的启动、停止和状态管理。
KtorHost.kt：基于 Ktor 框架的网络服务，处理隧道连接的 HTTP 请求和响应。
PGTunnelServiceImpl.kt：隧道服务的具体实现，封装了隧道连接的核心逻辑。
BootReceiver.java：系统启动时自动启动隧道服务的广播接收器。
AppCtx.java：应用上下文类，初始化隧道服务

## 3.1 问题

### 穿透的设备之间怎么通信？

- 直接连接（P2P） ：
    - 如果 NAT 允许，设备之间通过 STUN 获取的公网地址直接通信。
    - 数据通过加密隧道传输，确保安全性。
- 中继连接（TURN） ：
    - 如果 NAT 不允许直接连接，设备通过 TURN 服务器中继数据。
    - TURN 服务器将数据转发给目标设备，确保通信的可靠性。
- 混合模式（ICE） ：
    - 结合 STUN 和 TURN，自动选择最佳连接方式。
    - 优先使用直接连接，失败时使用中继连接

#### 2. p2p通信是什么？
P2P（Peer-to-Peer）通信是一种 去中心化 的通信模型，其中每个节点（peer）既可以是客户端，也可以是服务器。这与传统的客户端-服务器（Client-Server）模型不同，后者所有客户端请求都通过一个中心服务器。

#### 3. 提到的“穿透”指的是什么？讲讲 NAT、STUN、TURN

1. **穿透原理**
    - 打洞过程 ：
    1. 发现公网地址 ：通过 STUN 服务器，设备获取自己的公网 IP 和端口。
    2. 交换地址信息 ：设备通过公网服务器（如信令服务器）交换彼此的公网地址信息。
    3. 尝试直接连接 ：设备尝试使用对方的公网地址建立直接连接。
    4. 穿透 NAT ：如果 NAT 允许，设备之间可以直接通信；否则，需要使用 TURN 服务器中继数据。
2. **NAT**
    - 私有 IP 地址：这些地址在局域网（LAN）内使用，不会在互联网上直接路由
    - 允许多个设备共享一个公共 IP 地址以访问互联网
    - 设备位于 NAT 后时，无法直接从外部访问，因为 NAT 会隐藏设备的真实 IP 地址。
3. **STUN**
    - 允许 NAT 后的设备发现其公共 IP 地址和端口。当两个设备都知道对方的公共 IP 和端口时，它们就可以尝试建立 P2P 连接。
4. **TURN**
    - 数据中转站
    1. 设备注册 ：设备向 TURN 服务器注册，并获取一个中继地址（公网 IP 和端口）。
    2. 数据转发 ：设备将数据发送到 TURN 服务器，TURN 服务器将数据转发给目标设备。
    3. 通信建立 ：设备通过 TURN 服务器进行双向通信，确保数据能够到达对方。

### NAT 类型

- 全锥型（Full Cone）：
    - 所有从同一内网 IP 和端口发出的请求都映射成同一公网 IP 和端口
    - 任何外部主机都可通过这个 IP:Port 与内网通信
- 受限锥型（Restricted Cone）：
    - 只有内网发过请求的外部 IP 才能响应
- 端口受限锥型（Port Restricted Cone）：
    - 只有内网发过请求的外部 IP:Port 才能响应
- 对称型（Symmetric）：
    - 内网向不同外部 IP/Port 发请求时，会为每个映射一个新的公网 IP:Port；
    - 且只能收到特定目标的返回

### 你的这个过程中，怎么就得到公网ip地址和端口呢？

### 什么时候做的打洞，怎么打的洞？

tcp协议
nas节点先和服务器建立连接，相当有洞了
客户端向服务器

### 中国网络环境复杂，你这个成功率多少，有对nat类型的要求吗？

### 局域网内连接的流程

1. nas通过网线连接路由器
2. 手机连接路由器的wifi
3. 手机nas-app扫描该路由器下的ip地址，使用socket连接特定端口（Socket 通常基于 TCP 或 UDP 协议
4. 得到ip地址，点击连接或可通过网页访问

讲讲socket
穿透 相当于也是通过ip来访问的是吧
#### p2p是发http请求的吗
很多 P2P 网络使用自定义的协议或者基于 UDP、TCP 等传输层协议直接构建通信机制，而不依赖 HTTP 协议
即使使用了 NAT 穿透和 P2P 技术，手机依然可以通过发送 HTTP 请求来访问 NAS 上的 HTTP 服务

### 网络带宽

1. 优化p2p：
    - 选择合适的连接方式，优先stun，不行再turn
    - 动态调整，stun带宽不足，可尝试切换turn
2. 带宽管理与优化
    - 在设备端设置合理的数据传输速率限制，避免某个设备占用过多带宽，影响其他设备的正常使用
    - 数据压缩与优化 ：在传输数据前对其进行压缩，减少数据量
3. 内容分发优化
    - CDN
    - p2p内容分发

本质是ptop

Http去完成请求交互 继续tcp

Ptop实现映射

开启穿透 穿透客户端 127001 58000 对等本地接口  tcp多链路访问

穿透了 网速为直连经过的最短链路

带宽是5兆 500-600k

直连ptop打洞 云服务代为链接

服务器只负责握手

sdk负责转发 穿透线路切换

客户端开端口 本质上 http都是跟本机端口进行tcp连接 有个隔离 后续的中断 这个隔离的环节感知不到

58000  相当于穿透开的端口的映射

穿透起来 假设不穿透不转发  要超时才会知道超时响应 

有pid  就能让服务器找nas

有验证码 就能让nas提供功能

云端只提供握手能力