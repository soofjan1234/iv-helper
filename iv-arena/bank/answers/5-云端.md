## 什么是穿透？为什么要穿透？

当设备处在 NAT/防火墙之后、外网无法直接主动连接到内网设备时，通过一套机制让两端建立可用的通信通道

也就是我人在外面，想要通过手机访问在公司里的nas

首先，如果每个设备都有个公网ip，那么手机能够直接访问nas了，但是ip地址不够用，只能多个设备共用一个ip了；然后又有一个NAT技术，路由器给设备分配内网ip，设备能访问外网，外网却不能访问设备

## 穿透用到什么技术，如何通信

1. 用户层，我们是通过http over tcp访问本机 127.0.0.1:50080，穿透映射远程的50080端口到本机
2. 通道层：底层通道由穿透网络提供，优先使用 P2P 直连；直连失败时自动切到节点转发 / 中继转发
3. 内部实现上（由第三方 SDK 封装）会做：NAT 类型探测、 STUN、打洞什么的

STUN：“照镜子”。允许 NAT 后的设备发现其公共 IP 地址和端口。

TURN： “传声筒”。数据发给 TURN 服务器，由它帮两边转发。

ICE：会先尝试 P2P 直连，如果直连失败，自动切到 TURN 中转。

## 云端、客户端、服务端、穿透端交互流程

首先理清角色，云端是用于发凭证，客户端是手机电脑，服务端是nas，穿透端用于握手
总体来说就是客户端在外面、服务端在里面，想碰面怎么做？

1. 首先，都在里面的时候，客户端和服务端约定好如何碰面，服务端会请求云端领一些东西
    1. 身份证，用于服务端开启穿透
    2. 寻人编号，用于客户端向云端获取信息，在明，可展示给用户
    3. 接头暗号，用于客户端向服务端验证身份，在暗
2. 然后服务端会拿着身份证，去公网上的“穿透服务器”那里，开包间坐下
3. 客户端现在在外面了，把寻人编号给云端，问他这人在哪，云端查到后就给他位置，并给他接头暗号
4. 最后就是找到房间对暗号

## 穿透原理

一句话：**云端负责“发码找人”，穿透网络负责“连起来传数据”，客户端最终访问的其实是本机端口。**

1. 客户端问云端，对端是谁和暗号
2. 穿透 SDK 尝试直连（P2P）；直连不行就走转发/中继
3. SDK 做端口映射，把“远端 NAS 的服务端口”映射到本机 `127.0.0.1:<localPort>`，所以 App 只要连本机端口即可。

## 怎么得到的公网 IP 地址和端口？

客户端不需要得到公网 IP:端口，只需要知道对端是谁，然后调用穿透sdk封装了ConnectAdd即可

## 打洞（Hole Punching）是什么？怎么打

两个人在戒备森严的办公楼里想要互传信息，但是保安不给（办公楼就是局域网，保安就是NAT路由器），主要是骗过保安，因为发信息，他就会记录，等着放行回信。

1. Nas给公网服务器发信息，手机也给公网发信息要找Nas。
2. 公网服务器像个“中介”，把 NAS 的公网地址告诉手机，把手机的公网地址告诉 NAS。
3. 两边同时给对方的临时大门发包。保安认为是回信，放行。隧道通了，两人直接握手，不需要中介了。

## 中国网络环境复杂，你这个成功率多少，有对nat类型的要求吗？

连接成功没有问题：因为直连不行会自动走中继/转发，只要用户能正常上网，一般都能连通。

全锥、受限锥 → 最容易打洞直连，延迟和带宽最好；
端口受限锥 → 一般也能打洞，但成功率略低；
对称 NAT、运营商大规模 NAT（常见于移动网络） → P2P 成功率明显下降，更多依赖中继/转发。

## NAT 类型

- 全锥型（Full Cone）：
    - 所有从同一内网 IP 和端口发出的请求都映射成同一公网 IP 和端口
    - 任何外部主机都可通过这个 IP:Port 与内网通信
- 受限锥型（Restricted Cone）：
    - 只有内网发过请求的外部 IP 才能响应
- 端口受限锥型（Port Restricted Cone）：
    - 只有内网发过请求的外部 IP:Port 才能响应
- 对称型（Symmetric）：
    - 内网向不同外部 IP/Port 发请求时，会为每个映射一个新的公网 IP:Port；
    - 且只能收到特定目标的返回

## 为什么要加密

如果不加密，
NAS设备 → 云端: "给我发个访问码"
云端 → NAS: 返回 {accessID: "ABC123", accessVerify: "XYZ789", peerID: "peer001"}
中间人(如运营商、黑客)可以截获接头暗号，伪装成合法客户端连接你的NAS，你的私人数据(照片、文档)全部暴露

## 加密方式有哪些

### 1. 对称加密

用同一把钥匙开同一把锁，AES

1. 速度快(比RSA快100-1000倍)
2. 密钥分发困难，怎么安全的把密钥传给对方

### 2. 非对称加密

有两把钥匙，一把公钥，一把私钥。用公钥锁上的东西，只有对应的私钥能打开，RSA

1. 密钥分发简单
2. 速度慢、只能加密小数据(RSA-2048最多245字节)

### 3. 哈希算法

1. 正向极快，逆向极难：适合数据库存密码，用户一输入就知道对不对
2. 差之毫厘，谬以千里：适合文件校验，下载文件后对比哈希值

### 4. 数字签名

私钥加密，公钥解密

1. 消息哈希值 + 私钥加密 = 签名
2. 公钥解密签名,对比哈希值
3. 身份认证、防篡改、不可抵赖

### 5. 混合加密

1. RSA传输AES密钥,AES加密实际数据
2. 既快又安全

## 混合加密的方法

1. **生成密钥**：客户端生成 AES 的 `key` 和 `nonce`
2. **加密数据**：客户端用 AES 加密 `data`
3. **加密密钥**：客户端用 RSA 公钥加密 AES 的 `key`
4. **解密密钥**：服务端拿 RSA 私钥解密 `key`
5. **还原数据**：然后还原 `data`

## 四个项目分别的作用（从整体链路看）

### 1) `LincAccessCloud`（云端）

- **定位**：云端的“凭证/会合信息”管理服务（你实现的部分）。
- **主要做什么**：
  - NAS（Host）开启远程访问时，云端生成/下发并保存一组凭证：`accessID`（给用户/客户端用的访问码）和 `accessVerify`（握手鉴权用）。
  - 同时为该设备绑定一组穿透平台凭证：`peerID/peerPwd`（给 Host 侧登录/使用穿透平台）。
  - 客户端拿 `accessID` 请求云端，云端返回“找到对端并建立连接所需的信息”（例如 `peerID`、`accessVerify`、以及可选的上次内网 IP 等）。
- **一句话**：云端不负责传业务数据，主要负责**发码、查码、发连接所需信息**。

### 2) `LincUserManager`（NAS 本地服务端 / 服务端之一）

- **定位**：跑在 NAS 上的本地管理与认证服务（Go），对内提供本地 HTTP 服务（示例端口 `58000`）。
- **主要做什么**：
  - 处理 NAS 侧的本地业务（用户/认证/本地 API 等）。
  - 根据用户是否启用远程访问，按需触发 `OpenTunnel()`（开启或维护远程访问/穿透能力）。
  - 定时任务：IP 探测、隧道维护、NTP 等（保证“服务端在线/可被连接”）。
- **一句话**：NAS 上的“本地管家”，并在需要时**拉起/维护隧道**。

### 3) `pgtunnel`（Android 端穿透模块 / 客户端侧实现）

- **定位**：Android 上的穿透能力实现（前台常驻服务 + 端口映射 + 云端换凭证），面向“手机/客户端”使用场景。
- **主要做什么**：
  - 监听用户输入/保存的 `accessID`（访问码），向云端请求 `peerID + accessVerify`。
  - 启动隧道 SDK，并把远端 NAS 的服务端口映射到本机 `127.0.0.1:<localPort>`，客户端应用再去访问本机端口即可。
  - 网络变化/亮屏时尝试重新登录或恢复连接；也会把“局域网 IP”加入故障转移列表（能局域网直连就优先直连）。
- **一句话**：客户端这边的“拿码 -> 换信息 -> 建映射”，把远端服务**变成本机端口可访问**。

### 4) `lincaccessbackend`（Android 端穿透后台能力 / 服务端侧实现）

- **定位**：Android 环境下的后台常驻与隧道控制封装（更偏“设备侧/服务侧”）。
- **主要做什么**：
  - 常驻 `HostService` 监听网络变化/亮屏，触发登录/保活（保证“服务端侧”穿透能力持续可用）。
  - 封装对隧道 SDK 的调用（例如启动/停止、连接建立、鉴权回调处理、NAT/连接类型状态上报等）。
- **一句话**：设备侧的“后台守护 + 隧道控制”，确保服务端侧穿透**稳定在线**。