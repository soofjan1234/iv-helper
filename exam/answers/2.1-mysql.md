## 一、MySQL 基础架构

### 1.1 MySQL 执行流程

1. **连接器** - 身份认证和权限验证
2. **查询缓存** - 查询缓存（MySQL 8.0 已移除）
3. **分析器** - 词法分析、语法分析
4. **优化器** - 选择最优执行方案
5. **执行器** - 执行语句，返回结果
6. **存储引擎** - 数据存储和读取（插件式架构）

### 1.2 MyISAM 和 InnoDB 的区别

| 特性 | MyISAM | InnoDB |
| --- | --- | --- |
| 事务支持 | 不支持 | 支持 |
| 锁机制 | 表锁 | 行锁 |
| 外键支持 | 不支持 | 支持 |
| 崩溃恢复 | 不支持 | 支持（WAL + Redo Log） |
| MVCC | 不支持 | 支持 |
| 索引结构 | 索引和数据分离 | 索引即数据（聚簇索引） |

**外键：**

- 用于关联两个表的数据，使两个表关系更清晰，提高数据完整性
- 数据量大并发大，可能会导致性能瓶颈和死锁

**InnoDB 崩溃恢复机制**：

- **WAL (Write-Ahead Logging)**：先写日志，再写数据
- **Redo Log**：重做日志，保证持久性
- **Undo Log**：回滚日志，保证原子性和一致性

[RedoLog](https://www.notion.so/RedoLog-2f57cc2b705c801284defdc01e54a9f7?pvs=21)

---

## 二、事务

### 2.1 ACID 特性

原子性、持久性和隔离性，都是为了保证数据库状态的一致性

| 特性 | 说明 | 实现方式 |
| --- | --- | --- |
| 原子性 (Atomicity) | 事务要么全部成功，要么全部失败 | Undo Log |
| 一致性 (Consistency) | 事务前后数据保持一致 | 应用层 + 数据库约束 |
| 隔离性 (Isolation) | 事务之间互不干扰 | 锁 + MVCC |
| 持久性 (Durability) | 提交后数据永久保存 | Redo Log |

### 2.2 并发事务问题

| 问题 | 说明 |
| --- | --- |
| 脏读 | 读到其他事务未提交的数据 |
| 不可重复读 | 两次读取同一数据结果不同（被修改） |
| 幻读 | 两次读取记录数不同（被新增/删除） |
| 丢失修改 | 两个事务同时修改，一个覆盖另一个 |

### 2.3 事务隔离级别

| 隔离级别 | 脏读 | 不可重复读 | 幻读 |
| --- | --- | --- | --- |
| READ UNCOMMITTED | ✗ | ✗ | ✗ |
| READ COMMITTED | ✓ | ✗ | ✗ |
| REPEATABLE READ (MySQL默认) | ✓ | ✓ | 部分✓ |
| SERIALIZABLE | ✓ | ✓ | ✓ |

### 2.4 并发控制方式

1. **锁机制** - 悲观控制
2. **MVCC** - 多版本并发控制（读不阻塞写，写不阻塞读）
3. **乐观锁** - 版本号/时间戳

[MVCC](https://www.notion.so/MVCC-2f57cc2b705c807ab9e1f2cb0860a0f7?pvs=21)

---

## 三、索引

### 3.1 为什么用 B+ 树？

| 数据结构 | 问题 |
| --- | --- |
| Hash | 不支持顺序和范围查询 |
| 二叉查找树（左<右） | 可能退化成链表，O(n) |
| 平衡二叉树 | 维持平衡频繁旋转；范围查询，磁盘IO 次数多 |
| 红黑树 | 大致平衡；多次IO |
| B树 | 所有节点存放kv |
| B+ 树 | 叶子节点存放kv，并有链表，有助于范围查询 |

### 3.2 索引类型

| 类型 | 说明 |
| --- | --- |
| 主键索引 | 唯一且非空，聚簇索引 |
| 唯一索引 | 保证列值唯一 |
| 普通索引 | 加速查询 |
| 联合索引 | 多列组合，遵循最左前缀 |
| 覆盖索引 | 索引包含所需字段，无需回表 |

### 3.3 聚簇索引 vs 非聚簇索引

| 类型 | 说明 |
| --- | --- |
| 聚簇索引 | 数据和索引存储在一起，叶子节点存完整数据 |
| 非聚簇索引 | 叶子节点存主键值，需回表查询 |

### 3.4 索引失效场景

1. 对索引列做计算或函数操作
2. 隐式类型转换
3. LIKE '%xx'（左模糊）
4. OR 条件中有非索引列
5. IS NULL / IS NOT NULL
6. 联合索引违反最左前缀原则
7. 优化器判断全表扫描更快

---

## 四、日志

### 4.1 三大日志

| 日志 | 作用 | 层级 |
| --- | --- | --- |
| Binlog | 主从复制、数据恢复、审计 | Server 层 |
| Redo Log | 崩溃恢复，保证持久性 | InnoDB 引擎层 |
| Undo Log | 事务回滚，MVCC | InnoDB 引擎层 |

---

## 五、优化

### 5.1 慢查询分析步骤

1. 确认是否真的慢（设置 SQL_NO_CACHE）
2. 单表查询，找区分度最高的字段
3. EXPLAIN 查看执行计划
4. ORDER BY LIMIT 让排序表优先
5. 了解业务场景
6. 根据建索引原则加索引
7. 观察结果，不符合预期重新分析

### 5.2 EXPLAIN 关键字段

| 字段 | 说明 |
| --- | --- |
| type | 访问类型：ALL（全表）< index < range < ref < eq_ref < const |
| key | 实际使用的索引 |
| rows | 预估扫描行数 |
| Extra | 额外信息（Using index = 覆盖索引，Using filesort = 需优化） |

### 5.3 常见优化手段

1. 减少数据库查询次数（合并查询）
2. 添加合适的索引
3. 避免 SELECT *
4. 优化 SQL 结构