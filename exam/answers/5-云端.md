## 什么是穿透？为什么要穿透？

当设备处在 NAT/防火墙之后、外网无法直接主动连接到内网设备时，通过一套机制让两端建立可用的通信通道

也就是我人在外面，想要通过手机访问在公司里的nas

首先，如果每个设备都有个公网ip，那么手机能够直接访问nas了，但是ip地址不够用，只能多个设备共用一个ip了；然后又有一个NAT技术，路由器给设备分配内网ip，设备能访问外网，外网却不能访问设备

## 穿透用到什么技术，如何通信

1. 用户层，我们是通过http over tcp访问本机 127.0.0.1:50080，穿透映射远程的50080端口到本机
2. 通道层：底层通道由穿透网络提供，优先使用 P2P 直连；直连失败时自动切到节点转发 / 中继转发
3. 内部实现上（由第三方 SDK 封装）会做：NAT 类型探测、 STUN、打洞什么的

STUN：“照镜子”。允许 NAT 后的设备发现其公共 IP 地址和端口。

TURN： “传声筒”。数据发给 TURN 服务器，由它帮两边转发。

ICE：会先尝试 P2P 直连，如果直连失败，自动切到 TURN 中转。

## 云端、客户端、服务端、穿透端交互流程

首先理清角色，云端是用于发凭证，客户端是手机电脑，服务端是nas，穿透端用于握手
总体来说就是客户端在外面、服务端在里面，想碰面怎么做？

1. 首先，都在里面的时候，客户端和服务端约定好如何碰面，服务端会请求云端领一些东西
    1. 身份证，用于服务端开启穿透
    2. 寻人编号，用于客户端向云端获取信息，在明，可展示给用户
    3. 接头暗号，用于客户端向服务端验证身份，在暗
2. 然后服务端会拿着身份证，去公网上的“穿透服务器”那里，开包间坐下
3. 客户端现在在外面了，把寻人编号给云端，问他这人在哪，云端查到后就给他位置，并给他接头暗号
4. 最后就是找到房间对暗号

## 穿透原理

一句话：**云端负责“发码找人”，穿透网络负责“连起来传数据”，客户端最终访问的其实是本机端口。**

1. 客户端问云端，对端是谁和暗号
2. 穿透 SDK 尝试直连（P2P）；直连不行就走转发/中继
3. SDK 做端口映射，把“远端 NAS 的服务端口”映射到本机 `127.0.0.1:<localPort>`，所以 App 只要连本机端口即可。

## 怎么得到的公网 IP 地址和端口？

客户端不需要得到公网 IP:端口，只需要知道对端是谁，然后调用穿透sdk封装了ConnectAdd即可

## 打洞（Hole Punching）是什么？怎么打

两个人在戒备森严的办公楼里想要互传信息，但是保安不给（办公楼就是局域网，保安就是NAT路由器），主要是骗过保安，因为发信息，他就会记录，等着放行回信。

1. Nas给公网服务器发信息，手机也给公网发信息要找Nas。
2. 公网服务器像个“中介”，把 NAS 的公网地址告诉手机，把手机的公网地址告诉 NAS。
3. 两边同时给对方的临时大门发包。保安认为是回信，放行。隧道通了，两人直接握手，不需要中介了。

## 中国网络环境复杂，你这个成功率多少，有对nat类型的要求吗？

连接成功没有问题：因为直连不行会自动走中继/转发，只要用户能正常上网，一般都能连通。

全锥、受限锥 → 最容易打洞直连，延迟和带宽最好；
端口受限锥 → 一般也能打洞，但成功率略低；
对称 NAT、运营商大规模 NAT（常见于移动网络） → P2P 成功率明显下降，更多依赖中继/转发。

## NAT 类型

- 全锥型（Full Cone）：
    - 所有从同一内网 IP 和端口发出的请求都映射成同一公网 IP 和端口
    - 任何外部主机都可通过这个 IP:Port 与内网通信
- 受限锥型（Restricted Cone）：
    - 只有内网发过请求的外部 IP 才能响应
- 端口受限锥型（Port Restricted Cone）：
    - 只有内网发过请求的外部 IP:Port 才能响应
- 对称型（Symmetric）：
    - 内网向不同外部 IP/Port 发请求时，会为每个映射一个新的公网 IP:Port；
    - 且只能收到特定目标的返回

## 为什么要加密

如果不加密，
NAS设备 → 云端: "给我发个访问码"
云端 → NAS: 返回 {accessID: "ABC123", accessVerify: "XYZ789", peerID: "peer001"}
中间人(如运营商、黑客)可以截获接头暗号，伪装成合法客户端连接你的NAS，你的私人数据(照片、文档)全部暴露

## 加密方式有哪些

### 1. 对称加密

用同一把钥匙开同一把锁，AES

1. 速度快(比RSA快100-1000倍)
2. 密钥分发困难，怎么安全的把密钥传给对方

### 2. 非对称加密

有两把钥匙，一把公钥，一把私钥。用公钥锁上的东西，只有对应的私钥能打开，RSA

1. 密钥分发简单
2. 速度慢、只能加密小数据(RSA-2048最多245字节)

### 3. 哈希算法

1. 正向极快，逆向极难：适合数据库存密码，用户一输入就知道对不对
2. 差之毫厘，谬以千里：适合文件校验，下载文件后对比哈希值

### 4. 数字签名

私钥加密，公钥解密

1. 消息哈希值 + 私钥加密 = 签名
2. 公钥解密签名,对比哈希值
3. 身份认证、防篡改、不可抵赖

### 5. 混合加密

1. RSA传输AES密钥,AES加密实际数据
2. 既快又安全

## 混合加密的方法

1. **生成密钥**：客户端生成 AES 的 `key` 和 `nonce`
2. **加密数据**：客户端用 AES 加密 `data`
3. **加密密钥**：客户端用 RSA 公钥加密 AES 的 `key`
4. **解密密钥**：服务端拿 RSA 私钥解密 `key`
5. **还原数据**：然后还原 `data`